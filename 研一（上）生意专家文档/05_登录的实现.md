# 5 登录的实现
## 5.1 任务描述
### 5.1.1 任务介绍
- 完成用户的登录功能；
- 实现找回密码界面。
### 5.1.2 任务要求
#### 5.1.2.1 登录功能详细需求
用户场景：程序第一次运行时，用户在欢迎页上点击登录按钮进入登录页面。进入应用程序首页时如果之前用户没有登录过，或者登录时间已经过期，进入登录页面。用户登录成功后，就能够使用应用程序的所有功能。5天之内再使用软件都不需要再次登录。

输入/前置条件：用户已完成注册，用户未登录或者登录时间已过期。

流程说明：
无

需求描述：

字段 | 说明 | 数据来源
---|---|---
用户名 |必填，手机号码或者邮箱地址|用户输入 
密码 | 必填 |用户输入

软件原型

![登录页原型](https://note.youdao.com/yws/public/resource/5cb5d344007add789dde087c3fac8c5c/xmlnote/1525AC686DC84FC699A12C227D075A4C/1529)

交互：如果用户之前登录过，账户输入框中默认显示用户之前登录时用过的账号。

输出/后置条件：登录成功后，在本地存储中保存用户的登录状态和当前的登录时间，页面跳转到应用程序首页（Home）。

版本：
#### 5.1.2.2 找回密码界面详细需求
用户场景：用户在登录时忘记了登录密码，可以通过找回密码功能重新设置密码。在登录页上单击忘记密码按钮，页面跳转到找回密码页面。

输入/前置条件：已注册

流程说明：无

需求描述：

软件原型

![找回密码原型](https://note.youdao.com/yws/public/resource/5cb5d344007add789dde087c3fac8c5c/xmlnote/C34F3E81E9AD4F1D8D90613A5CF5A1AE/1514)

交互：无

输出/后置条件：无

版本：无
## 5.2 工作指导说明
资源名称 | 下载链接
---|---
登录页面图片压缩包 | [百度云下载](https://pan.baidu.com/s/1fK3qywBL78w6L4WMiz-k2g)
参考之前的任务把图片拷贝到工程指定的目录中。



### 5.2.1 实现用户服务
把组件类中的逻辑限制到只有视图需要的逻辑。所有其它逻辑都应该被放到服务；把可以重复使用的逻辑放到服务里，保持组件简单并聚焦于它们预期目的；
#### 5.2.1.1 多种方式登录的设计思路
登录时可用用手机或者邮箱登录。但在早期设计数据库时都是把用户名和密码放在同一张用户表中，增加一种登录方式都需要更改表的结构。扩展性相当糟糕，尤其引入使用第三方（微信、微博、QQ）登录后。
1. 用户表的设计

字段名 | 中文 | 类型 | 约束 | 说明
---|---|---|---|---
Id |编号||主键|自动增长
ShopName|店铺名称
Phone|电话
Email|邮箱
CreateDate|创建时间

2. 用户验证表的设计

字段名 | 中文 | 类型 | 约束 | 说明
---|---|---|---|---
Id |编号||主键|自动增长
UserId|用户编号||外键
Type|登录类型|||手机、邮箱、微信等
ThirdParty|是否第三方账号|||0表示是系统内置的账号，1表示是第三方账号
Identifier|登录标识|||手机号、邮箱、微信号
PasswordToken|凭证|||密码或者第三方登录凭证

#### 5.2.1.2 AJAX请求
统一AJAX请求时从服务器端返回的JSON对象
```typescript
export class AjaxResult {
  targetUrl: string;
  result: any;
  success: boolean;
  error: {
    message: string;
    details: string;
  };
  unAuthorizedRequest: boolean;
}
```
#### 5.2.1.3 实现注册方法
*src\app\services\user.service.ts*
```typescript
signup(shopName: string, phone: string, password: string, email: string): boolean {
  
}
```
```typescript
signup(register: Register): boolean {
  
}
```
```typescript
signup(shopName: string, phone: string, password: string, email: string): Promise<AjaxResult> {
  
}
```
```typescript
signup(register: Register): Promise<AjaxResult> {
  
}
```
```typescript
async signup(register: Register): AjaxResult {
  
}
```
#### 5.2.1.4 实现登录方法
*src\app\services\user.service.ts*
```typescript
login(username: string, password: string): boolean {
  
}
```


### 5.2.2 实现用户登陆功能
参考之前的任务，创建登录组件。参考之前的任务，实现在欢迎页点击登录按钮跳转到登录页。

#### 5.2.2.1 为登录组件添加属性和方法
*src\app\pages\login\login.page.ts*
```typescript
export class LoginPage {
  username: string = '';//视图模型的属性账号，双向绑定
  password: string = '';//视图模型的属性密码，双向绑定
  //...其他省略
  //点击登录按钮时调用
  onLogin() {
    //
  }
  //点击忘记密码时调用
  openForgotPassword() {
    //进入找回密码页面
  }
}
```

#### 5.2.2.2 登录界面
修改登录组件的模板文件

*src\app\pages\login\login.page.html*
```html
<ion-content no-padding>
  <img src="assets/img/logoin_title.jpg" alt="">
  <div padding-horizontal>
    <form #loginForm="ngForm">
    <ion-list padding-right no-margin>
      <ion-item lines="none"></ion-item>
      <ion-item>
        <ion-label position="fixed">账号</ion-label>
        <ion-input name="username" type="text" placeholder="手机号或者电子邮箱" [(ngModel)]="username"></ion-input>
      </ion-item>
      <ion-item margin-top>
        <ion-label position="fixed">密码</ion-label>
        <ion-input name="password" type="password" placeholder="您的生意专家登录密码" [(ngModel)]="password"></ion-input>
      </ion-item>
      <ion-item no-lines></ion-item>
    </ion-list>
    <ion-grid>
      <ion-row>
        <ion-col>
          <ion-button expand="full" color="primary" (click)="onLogin()">登录</ion-button>
        </ion-col>
        <ion-col>
          <ion-button expand="full" fill="outline" color="primary" href="/signup">注册新账号</ion-button>
        </ion-col>
      </ion-row>
      <ion-row>
        <ion-col>
          <ion-button fill="clear" size="small" (click)="openForgotPassword()">忘记密码？</ion-button>
        </ion-col>
      </ion-row>
      <ion-row text-center>
        <ion-col>查看演示</ion-col>
      </ion-row>
    </ion-grid>
    </form>
  </div>
</ion-content>
```
ion-label的positon属性可设置为以下4种值：

inline：把标签和控件排在一行内

fixed：与inline相似，但固定了标签的宽度，使用了 fixed 能让表单更整齐。

stacked：把标签固定在控件的左上方，使控件可以占据一整行；

floating：被激活以后，就会触发动画变成stacked的样子（这在 Android 的应用中经常出现）
> 要了解更多的lable的知识，请参考[官网](https://beta.ionicframework.com/docs/api/label/)

> 要了解更多的input的知识，请参考[官网](https://beta.ionicframework.com/docs/api/input)

#### 5.2.2.3 客户端验证提示
之前的任务中用户输入非法的数据时，给用户提示时使用的是Web App传统的方式。这次任务中使用移动端的Toast给用户提示信息。
1. 通过构造函数依赖注入

*src\app\pages\login\login.page.ts*
```typescript
constructor(private toastController: ToastController, private alertCtrl: AlertController) {
}
```
2. 在login方法中通过使用以下代码给用户提示

*src\app\pages\login\login.page.ts*
```typescript
async onLogin(form: NgForm) {
  // 判断的代码省略
  let toast = await this.toastController.create({
    message: '请输入您的手机号码或者邮箱',
    duration: 3000
  });
  toast.present();    
}

```

> 要了解更多的Toast的知识，请参考[ionic官网](https://beta.ionicframework.com/docs/api/toast)

> 要了解更多的Toast Controller的知识，请参考[ionic官网](https://beta.ionicframework.com/docs/api/toast-controller)

#### 5.2.2.4 判断用户名和密码是否正确

重要的信息使用Alerts给用户提示
1. 通过构造函数依赖注入

*src\app\pages\login\login.page.ts*
```typescript
constructor(private toastController:ToastController, private alertController:AlertController) {
}
```
*src\app\pages\login\login.page.ts*
```typescript
async onLogin(form: NgForm) {
  // 判断的代码省略
  let alert =await this.alertController.create({
    header: '提示',
    message:'用户名或者密码不正确',
    buttons:['确定']
  });
  alert.present();
}
```
> 要了解更多的Alert的知识，请参考[ionic官网](https://beta.ionicframework.com/docs/api/alert)

> 要了解更多的Alert Controller的知识，请参考[ionic官网](https://beta.ionicframework.com/docs/api/alert-controller)

**在开发中经常需要给用户信息提示，为了减少重复书写代码的数量，在后面的任务中需要使用服务封装信息提示。**

#### 5.2.2.5 其他
根据需求，完成剩余的登录功能。
1. 点击忘记密码，进入找回密码页面
2. 从本地存储中取出用户账户信息，判断用户名和密码是否正确
3. 登录成功后页面跳转到首页并把相关数据保存在本地存储中

### 5.2.3 完善app组件的处理 
根据需求，在app组件中实现相关逻辑的处理。根据相关条件给rootPage赋不同的值，通过赋值来决定页面跳转。

### 5.2.4 忘记密码界面
参考之前的任务，创建找回密码组件。记得修改app.module.ts文件，引入ForgotPasswordPage并设置@NgModule元数据中的entryComponents属性。参考之前的任务实现找回密码的页面跳转。
找回密码导航栏的实现

*src\app\pages\forgot-password\forgot-password.page.html*
```html
<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button text="返回"></ion-back-button>
    </ion-buttons>
    <ion-title>找回密码</ion-title>
  </ion-toolbar>
  <ion-toolbar>
    1、输入邮箱或者手机号>2、输入验证码>3、重置密码
  </ion-toolbar>
</ion-header>
```
根据需求，实现找回密码的表单界面。

> 要了解更多的back-button的知识，请参考[ionic官网](https://beta.ionicframework.com/docs/api/back-button)

### 5.2.6版权声明

把版权声明固定在程序的底部
*src\app\pages\login\login.page.html*
```html
<div style="position: fixed;left: 0; right: 0; bottom:10px;" text-center>
  <span>&copy;2010-2017 生意专家</span>
</div>
```
在登录页面和注册页面都有版权的声明，考虑到复用性和可维护性，创建组件。
1. 创建component
在app目录下创建components文件夹
```bash
ionic g component components/Copyright
```
创建成功后会自动修改app.module.ts文件。
```typescript
import { CopyrightComponent } from './components/copyright/copyright.component';
@NgModule({
  declarations: [AppComponent, CopyrightComponent],
```
删除declarations中的CopyrightComponent，删除相关的import。在components目录中创建一个模块文件，czb.module.ts。在declarations属性中添加CopyrightComponent，然后添加exports属性

*src\app\components\czb.mudule.ts*
```typescript
import { NgModule } from '@angular/core';
import { CommonModule } from '@angular/common';
import {CopyrightComponent} from './copyright/copyright.component';

@NgModule({
  imports: [
    CommonModule
  ],
  declarations: [CopyrightComponent],
  exports: [CopyrightComponent]
})
export class CzbModule { }
```
2. 修改copyright组件类，能够动态的设定版权距离底部的距离，自动获取当前时间的年份
*src\app\componets\copyright\copyright.ts*
```typescript
import { Component, Input } from '@angular/core';

@Component({
  selector: 'app-copyright',
  templateUrl: 'copyright.html'
})
export class CopyrightComponent {
  @Input() bottom: string;
  text: string;
  constructor() {
    let year = (new Date()).getFullYear();
    this.text = `2010-${year} 生意专家`;
    this.bottom = '10px';
  }
}
```
**这种字符串是被反引号包围（ `），并且以${ expr }这种形式嵌入表达式**
> 要了解更多的通过输入型绑定把数据从父组件传到子组件的知识，请参考[angular官网](https://www.angular.cn/guide/component-interaction)

> 要了解更多的插值表达式的知识，请参考[angular官网](https://www.angular.cn/guide/template-syntax#插值表达式----)

3. 使用属性绑定组件类的bottom属性

*src\app\componets\copyright\copyright.hml*
```html
<div style="position: fixed;left: 0; right: 0;" [style.bottom]="bottom" text-center>
  <span>&copy;{{text}}</span>
</div>
```

4. 在登录页中使用CopyrightComponent代替之前的div。使用时需要导入之前创建的模块，在imports属性中添加CzbModule。

*src\app\pages\login\login.module.ts*

```typescript
@NgModule({
  imports: [
    CommonModule,
    FormsModule,
    IonicModule,
    RouterModule.forChild(routes),
    CzbModule
  ],
  declarations: [HomePage]
})
export class HomePageModule {}
```
自动会在文件头部生成import代码

*src\app\pages\login\login.module.ts*

```typescript
import {CzbModule} from '../../components/czb.module';
```



*src\app\pages\login\login.page.html*
```html
<!-- 其他省略 -->
  <app-copyright [bottom]="'20px'"></app-copyright>
</ion-content>
```
5. 参考之前的任务在注册页中使用CopyrightComponent。

## 5.3 产品工作要求
1. 登录成功后，关闭应用程序。把系统日期改成4天后，重新启动应用程序，应直接进入首页。
2. 把系统日期改成6天后，重新启动应用程序，应进入登录页。

## 5.4 产品检查要求
